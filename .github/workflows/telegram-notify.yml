name: Notify Telegram

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    types: [opened, closed, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          BRANCH: ${{ github.ref_name }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
          PR_ACTION: ${{ github.event.action }}
          GITHUB_EVENT_JSON: ${{ toJson(github.event) }}
        run: |
          TELEGRAM_MENTION="@PhantomTear @Andresini_zX @Elcapodelpan"

          COMMITS=""
          if [ "$EVENT_NAME" = "push" ]; then
            while IFS= read -r line; do
              SAFE=$(echo "$line" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')
              COMMITS=$(printf '%s- %s\n' "$COMMITS" "$SAFE")
            done < <(echo "$GITHUB_EVENT_JSON" | jq -r '.commits[] | .message + " (" + .url + ")"')
          fi

          SAFE_PR_TITLE=$(echo "$PR_TITLE" | sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g')

          if [ "$EVENT_NAME" = "push" ]; then
            MESSAGE=$(printf '%s\nüöÄ <b>Nuevo push en %s</b>\nRama: %s\nAutor: %s\nCommits:\n%s' \
              "$TELEGRAM_MENTION" "$REPO" "$BRANCH" "$ACTOR" "$COMMITS")
          elif [ "$EVENT_NAME" = "pull_request" ]; then
            if [ "$PR_ACTION" = "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                MESSAGE=$(printf '%s\nüéâ <b>PR mergeada</b>\nRepo: %s\nRama: %s -> %s\nAutor: %s\nT√≠tulo: %s\n<a href='"'"'%s'"'"'>Ver PR</a>' \
                  "$TELEGRAM_MENTION" "$REPO" "$PR_HEAD_REF" "$PR_BASE_REF" "$ACTOR" "$SAFE_PR_TITLE" "$PR_URL")
              else
                MESSAGE=$(printf '%s\n‚ùå <b>PR cerrada sin merge</b>\nRepo: %s\nRama: %s -> %s\nAutor: %s\nT√≠tulo: %s\n<a href='"'"'%s'"'"'>Ver PR</a>' \
                  "$TELEGRAM_MENTION" "$REPO" "$PR_HEAD_REF" "$PR_BASE_REF" "$ACTOR" "$SAFE_PR_TITLE" "$PR_URL")
              fi
            elif [ "$PR_ACTION" = "synchronize" ]; then
              MESSAGE=$(printf '%s\nüîÑ <b>PR actualizada</b>\nRepo: %s\nRama: %s -> %s\nAutor: %s\nT√≠tulo: %s\n<a href='"'"'%s'"'"'>Ver PR</a>' \
                "$TELEGRAM_MENTION" "$REPO" "$PR_HEAD_REF" "$PR_BASE_REF" "$ACTOR" "$SAFE_PR_TITLE" "$PR_URL")
            else
              MESSAGE=$(printf '%s\nüîÄ <b>Nueva PR</b>\nRepo: %s\nRama: %s -> %s\nAutor: %s\nT√≠tulo: %s\n<a href='"'"'%s'"'"'>Ver PR</a>' \
                "$TELEGRAM_MENTION" "$REPO" "$PR_HEAD_REF" "$PR_BASE_REF" "$ACTOR" "$SAFE_PR_TITLE" "$PR_URL")
            fi
          fi

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "message_thread_id=${THREAD_ID}" \
            -d "parse_mode=HTML" \
            --data-urlencode "text=${MESSAGE}"

