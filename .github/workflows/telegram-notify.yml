name: Notify Telegram

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, closed, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        run: |
          EVENT_NAME=${{ github.event_name }}
          ACTOR=${{ github.actor }}
          REPO=${{ github.repository }}
          BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID=${{ secrets.TELEGRAM_THREAD_ID }}

          # Mencionar a todos los miembros
          TELEGRAM_MENTION="@PhantomTear @Andresini_zX @Elcapodelpan"

          # Inicializar variables
          PR_URL=""
          PR_TITLE=""
          BRANCH=""
          BASE_BRANCH=""
          COMMITS=""

          # Si es push
          if [ "$EVENT_NAME" = "push" ]; then
            BRANCH=${{ github.ref_name }}
            for c in $(jq -r '.commits[] | "- " + .message + " (" + .url + ")"' <<< "${{ toJson(github.event) }}"); do
              COMMITS="$COMMITS$c\n"
            done
          fi

          # Si es PR
          if [ "$EVENT_NAME" = "pull_request" ]; then
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            BRANCH="${{ github.event.pull_request.head.ref }}"
            BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          fi

          # Construir mensaje
          if [ "$EVENT_NAME" = "push" ]; then
            MESSAGE="$TELEGRAM_MENTION ðŸš€ *Nuevo push en $REPO*\nRama: $BRANCH\nAutor: $ACTOR\nCommits:\n$COMMITS"
          elif [ "$EVENT_NAME" = "pull_request" ]; then
            if [ "${{ github.event.action }}" = "closed" ]; then
              MESSAGE="$TELEGRAM_MENTION âœ… *PR cerrada*\nRepo: $REPO\nRama: $BRANCH â†’ $BASE_BRANCH\nAutor: $ACTOR\nTÃ­tulo: $PR_TITLE\n[Ver PR]($PR_URL)"
            else
              MESSAGE="$TELEGRAM_MENTION ðŸ”€ *Nueva PR*\nRepo: $REPO\nRama: $BRANCH â†’ $BASE_BRANCH\nAutor: $ACTOR\nTÃ­tulo: $PR_TITLE\n[Ver PR]($PR_URL)"
            fi
          fi

          # Enviar mensaje a Telegram usando Markdown
          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id=$CHAT_ID \
            -d message_thread_id=$THREAD_ID \
            -d parse_mode=Markdown \
            --data-urlencode text="$MESSAGE"


