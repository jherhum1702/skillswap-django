name: Notify Telegram

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, closed, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables and send message
        run: |
          EVENT_NAME=${{ github.event_name }}
          ACTOR=${{ github.actor }}
          REPO=${{ github.repository }}
          BRANCH=${{ github.ref_name }}
          BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID=${{ secrets.TELEGRAM_THREAD_ID }}

          # Mencionar a todos los miembros
          TELEGRAM_MENTION="@PhantomTear @Andresini_zX @Elcapodelpan"

          # PR info solo si existe
          PR_URL=""
          PR_TITLE=""
          if [ "$EVENT_NAME" = "pull_request" ]; then
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
          fi

          # Lista de commits si es push
          COMMITS=""
          if [ "$EVENT_NAME" = "push" ]; then
            for c in $(jq -r '.commits[] | "- " + .message + " (" + .url + ")"' <<< "${{ toJson(github.event) }}"); do
              COMMITS="$COMMITS$c\n"
            done
          fi

          # Construir mensaje segÃºn evento
          if [ "$EVENT_NAME" = "push" ]; then
            MESSAGE="ðŸš€ <b>Nuevo push</b>\n<b>Repo:</b> $REPO\n<b>Rama:</b> $BRANCH\n<b>Autor:</b> $ACTOR\n$COMMITS"
          elif [ "$EVENT_NAME" = "pull_request" ]; then
            if [ "${{ github.event.action }}" = "closed" ]; then
              MESSAGE="âœ… <b>PR cerrada</b>\n<b>Repo:</b> $REPO\n<b>Rama:</b> $BRANCH\n<b>Autor:</b> $ACTOR\n<b>TÃ­tulo:</b> $PR_TITLE\n<a href='$PR_URL'>Ver PR</a>"
            else
              MESSAGE="ðŸ”€ <b>Nueva PR</b>\n<b>Repo:</b> $REPO\n<b>Rama:</b> $BRANCH\n<b>Autor:</b> $ACTOR\n<b>TÃ­tulo:</b> $PR_TITLE\n<a href='$PR_URL'>Ver PR</a>"
            fi
          fi

          # Enviar mensaje a Telegram
          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id=$CHAT_ID \
            -d message_thread_id=$THREAD_ID \
            -d parse_mode=HTML \
            --data-urlencode text="$TELEGRAM_MENTION $MESSAGE"
