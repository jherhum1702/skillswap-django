name: Notify Telegram

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, closed, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        run: |
          EVENT_NAME="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          THREAD_ID="${{ secrets.TELEGRAM_THREAD_ID }}"
          MENTION="@PhantomTear @Andresini_zX @Elcapodelpan"
          BRANCH="${{ github.ref_name || github.event.pull_request.head.ref }}"
          PR_URL="${{ github.event.pull_request.html_url || '' }}"
          PR_TITLE="${{ github.event.pull_request.title || '' | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref || '' }}"
          ACTION="${{ github.event.action || '' }}"

          if [ "$EVENT_NAME" = "push" ]; then
            MSG="$MENTION ðŸš€ Nuevo push $REPO rama $BRANCH por $ACTOR"
            curl -s -X POST \
              "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d message_thread_id="$THREAD_ID" \
              -d parse_mode="HTML" \
              -d "text=$MSG"
          fi

          if [ "$EVENT_NAME" = "pull_request" ]; then
            if [ "$ACTION" = "closed" ]; then
              STATUS="âœ… PR cerrada"
            else
              STATUS="ðŸ”€ Nueva PR"
            fi
            MSG="$MENTION $STATUS $REPO $BRANCH â†’ $BASE_BRANCH
TÃ­tulo: $PR_TITLE
$PR_URL"
            curl -s -X POST \
              "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d message_thread_id="$THREAD_ID" \
              -d parse_mode="HTML" \
              -d "text=$MSG"
          fi

